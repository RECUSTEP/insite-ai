name: Deploy API (Wrangler)

on:
  push:
    branches:
      - prd
      - stg

env:
  CLOUDFLARE_API_TOKEN:  ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write

    steps:
      # 1) ソースチェックアウト
      - uses: actions/checkout@v4

      # 2) Node.js + pnpm
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: corepack enable

      # 3) モノレポ全体の依存をインストール
      - run: pnpm install -r

      # 4) apps/api 配下でも依存を補完（hono などがある workspace）
      - run: pnpm --filter apps/api install

      # 5) D1 マイグレーションを実行（デプロイ前に必須）
      - name: Apply D1 Migrations
        run: |
          cd apps/api
          if [ "${{ github.ref_name }}" = "prd" ]; then
            npx wrangler@4 d1 migrations apply database --remote || echo "Migration may have already been applied"
          else
            npx wrangler@4 d1 migrations apply database --remote --env preview || echo "Migration may have already been applied"
          fi
        env:
          CLOUDFLARE_API_TOKEN:   ${{ env.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID:  ${{ env.CLOUDFLARE_ACCOUNT_ID }}
      
      # 5.5) 最新マイグレーション（0005）を個別に適用（冪等性保証）
      - name: Apply Latest Migration (0005) - Add Revision Columns
        run: |
          cd apps/api
          if [ "${{ github.ref_name }}" = "prd" ]; then
            npx wrangler@4 d1 execute database --remote --command "ALTER TABLE analysis_history ADD COLUMN revision_parent_id TEXT;" || echo "Column may already exist"
            npx wrangler@4 d1 execute database --remote --command "ALTER TABLE analysis_history ADD COLUMN version INTEGER DEFAULT 1 NOT NULL;" || echo "Column may already exist"
            npx wrangler@4 d1 execute database --remote --command "CREATE INDEX IF NOT EXISTS analysis_history_revision_parent_id_idx ON analysis_history (revision_parent_id);" || echo "Index may already exist"
          else
            npx wrangler@4 d1 execute database --remote --env preview --command "ALTER TABLE analysis_history ADD COLUMN revision_parent_id TEXT;" || echo "Column may already exist"
            npx wrangler@4 d1 execute database --remote --env preview --command "ALTER TABLE analysis_history ADD COLUMN version INTEGER DEFAULT 1 NOT NULL;" || echo "Column may already exist"
            npx wrangler@4 d1 execute database --remote --env preview --command "CREATE INDEX IF NOT EXISTS analysis_history_revision_parent_id_idx ON analysis_history (revision_parent_id);" || echo "Index may already exist"
          fi
        env:
          CLOUDFLARE_API_TOKEN:   ${{ env.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID:  ${{ env.CLOUDFLARE_ACCOUNT_ID }}

      # 6) Wrangler 4 CLI で確実にデプロイ
      - name: Publish Worker via CLI
        run: |
          cd apps/api
          if [ "${{ github.ref_name }}" = "prd" ]; then
            npx wrangler@4 deploy --config wrangler.toml
          else
            npx wrangler@4 deploy --config wrangler.toml --env preview
          fi
        env:
          CLOUDFLARE_API_TOKEN:   ${{ env.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID:  ${{ env.CLOUDFLARE_ACCOUNT_ID }}
